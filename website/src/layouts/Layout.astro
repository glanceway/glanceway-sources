---
import "../styles/global.css";
import { Sun, Moon, Monitor } from "@lucide/astro";
import LanguageSwitcher from "../components/LanguageSwitcher.astro";
import {
  useTranslations,
  getLocalePath,
  defaultLocale,
  locales,
  localeKeys,
} from "../i18n/index";

interface Props {
  title: string;
  locale?: string;
  hideLanguageSwitcher?: boolean;
}

const { title, locale = defaultLocale, hideLanguageSwitcher = false } = Astro.props;
const t = useTranslations(locale);
const dir = locales[locale]?.dir ?? "ltr";
const currentPath = Astro.url.pathname;

// Build base path for hreflang (strip locale prefix)
function getBasePath(path: string, loc: string): string {
  if (loc === defaultLocale) return path;
  const prefix = `/${loc}`;
  if (path === prefix || path === `${prefix}/`) return "/";
  if (path.startsWith(`${prefix}/`)) return path.slice(prefix.length);
  return path;
}
const basePath = getBasePath(currentPath, locale);
---

<!doctype html>
<html lang={locale} dir={dir}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Glanceway" />
    <link rel="manifest" href="/site.webmanifest" />
    {
      localeKeys.map((loc) => (
        <link
          rel="alternate"
          hreflang={loc === defaultLocale ? "x-default" : loc}
          href={getLocalePath(loc, basePath)}
        />
      ))
    }
    <script is:inline>
      (function () {
        var theme = localStorage.getItem("theme") || "system";
        var isDark =
          theme === "dark" ||
          (theme === "system" &&
            window.matchMedia("(prefers-color-scheme: dark)").matches);
        if (isDark) document.documentElement.classList.add("dark");

        var modes = ["light", "dark", "system"];

        function getTheme() {
          return localStorage.getItem("theme") || "system";
        }

        function applyTheme(t) {
          var d =
            t === "dark" ||
            (t === "system" &&
              window.matchMedia("(prefers-color-scheme: dark)").matches);
          document.documentElement.classList.toggle("dark", d);
          var icons = document.querySelectorAll(".theme-icon");
          icons.forEach(function (icon) {
            icon.style.display = icon.dataset.theme === t ? "" : "none";
          });
        }

        function init() {
          var btn = document.getElementById("theme-toggle");
          if (!btn || btn.dataset.themeInit) return;
          btn.dataset.themeInit = "1";
          btn.addEventListener("click", function () {
            var cur = getTheme();
            var next = modes[(modes.indexOf(cur) + 1) % modes.length];
            localStorage.setItem("theme", next);
            applyTheme(next);
          });
          applyTheme(getTheme());
          window
            .matchMedia("(prefers-color-scheme: dark)")
            .addEventListener("change", function () {
              if (getTheme() === "system") applyTheme("system");
            });
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          init();
        }
      })();
    </script>
  </head>
  <body
    class="min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100"
  >
    <header class="bg-white shadow-sm dark:bg-gray-900">
      <div
        class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4"
      >
        <a
          href={getLocalePath(locale, "/")}
          class="flex items-center gap-2.5 text-lg font-bold tracking-tight text-gray-900 no-underline dark:text-white"
        >
          <img src="/logo.svg" alt="Glanceway" class="h-8 w-8 dark:invert" />
          Glanceway
        </a>
        <nav class="flex items-center gap-4 text-sm">
          <a
            href={getLocalePath(locale, "/sources")}
            class="font-medium text-gray-600 no-underline hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
          >{t("nav.sources")}</a>
          {!hideLanguageSwitcher && <LanguageSwitcher locale={locale} currentPath={currentPath} />}
          <button
            id="theme-toggle"
            class="flex h-8 w-8 items-center justify-center rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-400 dark:hover:bg-gray-800 dark:hover:text-white"
            aria-label="Toggle theme"
          >
            <Sun class="theme-icon h-4 w-4" data-theme="light" />
            <Moon class="theme-icon h-4 w-4" data-theme="dark" />
            <Monitor class="theme-icon h-4 w-4" data-theme="system" />
          </button>
        </nav>
      </div>
    </header>
    <main>
      <slot />
    </main>
    <footer
      class="border-t border-gray-200 bg-white dark:border-gray-800 dark:bg-gray-900"
    >
      <div class="mx-auto max-w-6xl px-6 py-8">
        <div
          class="flex flex-col items-center justify-between gap-4 sm:flex-row"
        >
          <div
            class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white"
          >
            <img src="/logo.svg" alt="Glanceway" class="h-5 w-5 dark:invert" />
            Glanceway
          </div>
          <div
            class="flex items-center gap-6 text-sm text-gray-400 dark:text-gray-500"
          >
            <a
              href={getLocalePath(locale, "/sources")}
              class="hover:text-gray-600 dark:hover:text-gray-300"
              >{t("nav.sources")}</a
            >
            <a
              href="/privacy"
              class="hover:text-gray-600 dark:hover:text-gray-300"
              >Privacy</a
            >
          </div>
        </div>
        <div class="mt-6 text-center text-xs text-gray-300 dark:text-gray-600">
          {t("footer.copyright", { year: new Date().getFullYear().toString() })}
        </div>
      </div>
    </footer>
  </body>
</html>
